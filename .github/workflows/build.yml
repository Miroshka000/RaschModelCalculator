name: ğŸ”¨ Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  test:
    name: ğŸ§ª Test Application
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: ğŸ˜ Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: ğŸ”§ Make Gradlew Executable
        run: chmod +x ./gradlew
        if: runner.os != 'Windows'

      - name: ğŸ“¦ Cache Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ğŸ§ª Run Tests
        run: ./gradlew test

      - name: ğŸ” Generate Test Report
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: "ğŸ“Š Test Results (${{ matrix.os }})"
          path: build/test-results/test/*.xml
          reporter: java-junit

      - name: ğŸ“Š Upload Test Results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results-${{ matrix.os }}
          path: |
            build/test-results/
            build/reports/tests/

  build:
    name: ğŸ—ï¸ Build Application
    runs-on: windows-latest
    needs: test
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: ğŸ˜ Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: ğŸ“¦ Cache Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ğŸ—ï¸ Build Application
        run: ./gradlew clean build

      - name: ğŸ“¦ Create JPackage (Windows)
        run: ./gradlew jpackage

      - name: ğŸ“ Prepare Build Artifacts
        run: |
          mkdir build-artifacts
          
          # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ JAR Ñ„Ğ°Ğ¹Ğ»Ñ‹
          if (Test-Path "build/libs/*.jar") {
            Copy-Item "build/libs/*.jar" "build-artifacts/"
            Write-Host "âœ… Copied JAR files"
          }
          
          # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
          if (Test-Path "build/jpackage/*.exe") {
            Copy-Item "build/jpackage/*.exe" "build-artifacts/"
            Write-Host "âœ… Copied executable files"
          }
          
          # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ñ‹
          if (Test-Path "build/reports") {
            Copy-Item -Recurse "build/reports" "build-artifacts/"
            Write-Host "âœ… Copied reports"
          }
          
          Write-Host "ğŸ“‹ Build artifacts:"
          Get-ChildItem -Recurse "build-artifacts/"
        shell: powershell

      - name: ğŸ“Š Upload Build Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts-${{ github.sha }}
          path: build-artifacts/
          retention-days: 7

      - name: ğŸ§¹ Cleanup
        run: ./gradlew --stop

  code-quality:
    name: ğŸ” Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: ğŸ˜ Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: ğŸ“¦ Cache Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: ğŸ” Run SpotBugs
        run: ./gradlew spotbugsMain || true

      - name: ğŸ“‹ Check Code Style
        run: ./gradlew checkstyleMain || true

      - name: ğŸ§ª Run PMD
        run: ./gradlew pmdMain || true

      - name: ğŸ“Š Upload Quality Reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: quality-reports-${{ github.sha }}
          path: |
            build/reports/spotbugs/
            build/reports/checkstyle/
            build/reports/pmd/
          retention-days: 7

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”’ Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ğŸ“Š Upload Trivy Scan Results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  notify:
    name: ğŸ“¢ Build Status
    runs-on: ubuntu-latest
    needs: [test, build, code-quality, security-scan]
    if: always()
    
    steps:
      - name: ğŸ‰ Success Notification
        if: needs.test.result == 'success' && needs.build.result == 'success'
        run: |
          echo "ğŸ‰ Build completed successfully!"
          echo "âœ… All tests passed"
          echo "âœ… Application built successfully"
          echo "ğŸ“¦ Artifacts uploaded"

      - name: âŒ Failure Notification
        if: needs.test.result == 'failure' || needs.build.result == 'failure'
        run: |
          echo "âŒ Build failed!"
          echo "ğŸ” Check the logs for details"
          exit 1
