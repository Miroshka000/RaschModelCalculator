name: 🚀 Build and Release

on:
  push:
    branches: [master]
    paths:
      - 'build.gradle.kts'
  workflow_dispatch: 

env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  build-and-release:
    name: 🏗️ Build and Release
    runs-on: windows-latest
    outputs:
      release_created: ${{ steps.check_release.outputs.created }}
      version: ${{ steps.version.outputs.VERSION }}
    
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ☕ Setup Java JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: 🐘 Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: wrapper

      - name: 🔧 Make Gradlew Executable
        run: chmod +x ./gradlew
        shell: bash

      - name: 📦 Cache Gradle Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: 🏷️ Extract Version from Gradle
        id: version
        run: |

          VERSION=$(grep 'version = ' build.gradle.kts | sed 's/version = "\(.*\)"/\1/')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
          
          if gh release view "v$VERSION" >/dev/null 2>&1; then
            echo "RELEASE_EXISTS=true" >> $GITHUB_OUTPUT
            echo "Release v$VERSION already exists"
          else
            echo "RELEASE_EXISTS=false" >> $GITHUB_OUTPUT
            echo "Release v$VERSION does not exist, will create new one"
          fi
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}

      - name: 🏷️ Create Git Tag
        if: steps.version.outputs.RELEASE_EXISTS == 'false'
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "v$VERSION"
          git push origin "v$VERSION"
          echo "Created and pushed tag: v$VERSION"
        shell: bash

      - name: 📝 Update Application Properties
        if: steps.version.outputs.RELEASE_EXISTS == 'false'
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          echo "version=$VERSION" > src/main/resources/application.properties
          echo "Updated application.properties with version: $VERSION"
        shell: bash

      - name: 🏗️ Build Application
        if: steps.version.outputs.RELEASE_EXISTS == 'false'
        run: ./gradlew clean build
        shell: bash

      - name: 📦 Create JPackage Distribution
        if: steps.version.outputs.RELEASE_EXISTS == 'false'
        run: ./gradlew jpackage
        shell: bash

      - name: 📁 Prepare Release Assets
        if: steps.version.outputs.RELEASE_EXISTS == 'false'
        run: |
          mkdir -p release-assets
          
          # Копируем исполняемый файл
          if [ -f "build/jpackage/RaschModelCalculator-${{ steps.version.outputs.VERSION }}.exe" ]; then
            cp "build/jpackage/RaschModelCalculator-${{ steps.version.outputs.VERSION }}.exe" "release-assets/"
            echo "✅ Copied installer executable"
          else
            echo "❌ Installer executable not found"
            ls -la build/jpackage/
          fi
          
          # Копируем JAR файл
          if [ -f "build/libs/RaschModelCalculator-${{ steps.version.outputs.VERSION }}.jar" ]; then
            cp "build/libs/RaschModelCalculator-${{ steps.version.outputs.VERSION }}.jar" "release-assets/"
            echo "✅ Copied JAR file"
          else
            echo "❌ JAR file not found"
            ls -la build/libs/
          fi
          
          # Создаем чексуммы
          cd release-assets
          sha256sum * > checksums.txt
          cd ..
          
          echo "📋 Release assets prepared:"
          ls -la release-assets/
        shell: bash

      - name: 📄 Generate Release Notes
        if: steps.version.outputs.RELEASE_EXISTS == 'false'
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          RELEASE_NOTES="## 🎉 Rasch Model Calculator v$VERSION

          ### ✨ Новые возможности
          - Современный игровой интерфейс с градиентами и эффектами
          - Система автообновления с GitHub Releases
          - Улучшенные карточки статистики на dashboard
          - Анимации и современные переходы
          - Обновленная навигация с иконками

          ### 🔧 Технические улучшения
          - Переработанная архитектура UI компонентов
          - Асинхронная обработка операций
          - Улучшенная обработка ошибок
          - Оптимизированная производительность

          ### 📦 Что включено
          - **RaschModelCalculator-$VERSION.exe** - Установщик для Windows
          - **RaschModelCalculator-$VERSION.jar** - JAR файл для всех платформ
          - **checksums.txt** - Контрольные суммы файлов

          ### 💻 Системные требования
          - Windows 10 или новее
          - Java 17+ (для JAR версии)
          - 4 ГБ оперативной памяти
          - 100 МБ свободного места

          ### 🔄 Автообновление
          Эта версия поддерживает автоматическое обновление. Приложение будет проверять наличие новых версий при запуске.

          ---
          💻 Создано с ❤️ Miroshka"

          # Сохраняем в файл и переменную
          echo "$RELEASE_NOTES" > release_notes.md
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "RELEASE_NOTES<<$EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT
        shell: bash

      - name: 🚀 Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: success() && steps.version.outputs.RELEASE_EXISTS == 'false'
        with:
          tag_name: "v${{ steps.version.outputs.VERSION }}"
          name: "🎯 Rasch Model Calculator v${{ steps.version.outputs.VERSION }}"
          body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
          files: |
            release-assets/*
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}

      - name: ✅ Set Release Created Flag
        id: check_release
        run: |
          if [[ "${{ steps.version.outputs.RELEASE_EXISTS }}" == "false" ]]; then
            echo "created=true" >> $GITHUB_OUTPUT
            echo "Release was created"
          else
            echo "created=false" >> $GITHUB_OUTPUT
            echo "Release already existed, skipped creation"
          fi
        shell: bash

      - name: 📊 Upload Build Artifacts
        uses: actions/upload-artifact@v4.6.2
        with:
          name: rasch-calculator-${{ steps.version.outputs.VERSION }}
          path: |
            release-assets/
            build/reports/
          retention-days: 30

      - name: 🧹 Cleanup Build Cache
        run: |
          ./gradlew --stop
          rm -rf ~/.gradle/caches/build-cache-*
        shell: bash

  notify-success:
    name: 📢 Notification
    runs-on: ubuntu-latest
    needs: [build-and-release]
    if: success() && needs.build-and-release.outputs.release_created == 'true'
    
    steps:
      - name: 🎉 Success Notification
        run: |
          echo "🎉 Release created successfully!"
          echo "🔗 Release URL: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.build-and-release.outputs.version }}"
          echo "📥 Users can now download and auto-update will detect this version"

  notify-failure:
    name: ❌ Build Failure
    runs-on: ubuntu-latest
    needs: [build-and-release]
    if: failure()
    
    steps:
      - name: ❌ Build Failure Notification
        run: |
          echo "❌ Build failed! Release cancelled."
          echo "🔗 Check workflow: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "⚠️ Fix build errors before creating a release"

  notify-skip:
    name: ⏭️ Release Skipped
    runs-on: ubuntu-latest
    needs: [build-and-release]
    if: success() && needs.build-and-release.outputs.release_created == 'false'
    
    steps:
      - name: ⏭️ Skip Notification
        run: |
          echo "⏭️ Release skipped - version v${{ needs.build-and-release.outputs.version }} already exists"
          echo "🔗 Existing release: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.build-and-release.outputs.version }}"
          echo "💡 Update version in build.gradle.kts to create a new release"
