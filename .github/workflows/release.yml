name: ğŸš€ Build and Release

on:
  push:
    branches: [master]
    paths:
      - 'build.gradle.kts'
  workflow_dispatch: 

permissions:
  contents: write
  packages: write
  actions: read

env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  build-and-release:
    name: ğŸ—ï¸ Build and Release
    runs-on: windows-latest
    outputs:
      release_created: ${{ steps.check_release.outputs.created }}
      version: ${{ steps.version.outputs.VERSION }}
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Setup Java JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: ğŸ˜ Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: wrapper

      - name: ğŸ”§ Setup Gradle
        run: |
          # Ğ¡Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ gradlew Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼Ñ‹Ğ¼
          chmod +x ./gradlew
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ wrapper jar
          if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ]; then
            echo "âŒ gradle-wrapper.jar not found, downloading..."
            # Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ wrapper jar ĞµÑĞ»Ğ¸ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚
            mkdir -p gradle/wrapper
            curl -L -o gradle/wrapper/gradle-wrapper.jar https://github.com/gradle/gradle/raw/v8.13/gradle/wrapper/gradle-wrapper.jar
          fi
          
          echo "âœ… Gradle wrapper ready"
        shell: bash

      - name: ğŸ“¦ Cache Gradle Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ğŸ·ï¸ Extract Version from Gradle
        id: version
        run: |

          VERSION=$(grep -A 1 'group = "miroshka"' build.gradle.kts | grep 'version = ' | sed 's/version = "\(.*\)"/\1/')
          
          if [ -z "$VERSION" ]; then
            echo "âŒ Failed to extract version from build.gradle.kts"
            exit 1
          fi
          
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
          
          if gh release view "v$VERSION" >/dev/null 2>&1; then
            echo "RELEASE_EXISTS=true" >> $GITHUB_OUTPUT
            echo "Release v$VERSION already exists"
          else
            echo "RELEASE_EXISTS=false" >> $GITHUB_OUTPUT
            echo "Release v$VERSION does not exist, will create new one"
          fi
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}

      - name: ğŸ·ï¸ Create Git Tag
        if: steps.version.outputs.RELEASE_EXISTS == 'false'
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "v$VERSION"
          git push origin "v$VERSION"
          echo "Created and pushed tag: v$VERSION"
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}

      - name: ğŸ“ Update Application Properties
        if: steps.version.outputs.RELEASE_EXISTS == 'false'
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          echo "version=$VERSION" > src/main/resources/application.properties
          echo "Updated application.properties with version: $VERSION"
        shell: bash

      - name: ğŸ—ï¸ Build Application
        if: steps.version.outputs.RELEASE_EXISTS == 'false'
        run: ./gradlew clean build
        shell: bash

      - name: ğŸ“¦ Create JPackage Distribution
        if: steps.version.outputs.RELEASE_EXISTS == 'false'
        run: ./gradlew jpackage
        shell: bash

      - name: ğŸ“ Prepare Release Assets
        if: steps.version.outputs.RELEASE_EXISTS == 'false'
        run: |
          mkdir -p release-assets
          
          # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ»
          if [ -f "build/jpackage/RaschModelCalculator-${{ steps.version.outputs.VERSION }}.exe" ]; then
            cp "build/jpackage/RaschModelCalculator-${{ steps.version.outputs.VERSION }}.exe" "release-assets/"
            echo "âœ… Copied installer executable"
          else
            echo "âŒ Installer executable not found"
            ls -la build/jpackage/
          fi
          
          # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ JAR Ñ„Ğ°Ğ¹Ğ»
          if [ -f "build/libs/RaschModelCalculator-${{ steps.version.outputs.VERSION }}.jar" ]; then
            cp "build/libs/RaschModelCalculator-${{ steps.version.outputs.VERSION }}.jar" "release-assets/"
            echo "âœ… Copied JAR file"
          else
            echo "âŒ JAR file not found"
            ls -la build/libs/
          fi
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ‡ĞµĞºÑÑƒĞ¼Ğ¼Ñ‹
          cd release-assets
          sha256sum * > checksums.txt
          cd ..
          
          echo "ğŸ“‹ Release assets prepared:"
          ls -la release-assets/
        shell: bash

      - name: ğŸ“„ Generate Release Notes
        if: steps.version.outputs.RELEASE_EXISTS == 'false'
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          RELEASE_NOTES="## ğŸ‰ Rasch Model Calculator v$VERSION


          ---
          ğŸ’» Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¾ Ñ â¤ï¸ Miroshka"

          # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² Ñ„Ğ°Ğ¹Ğ» Ğ¸ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½ÑƒÑ
          echo "$RELEASE_NOTES" > release_notes.md
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "RELEASE_NOTES<<$EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT
        shell: bash

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: success() && steps.version.outputs.RELEASE_EXISTS == 'false'
        with:
          tag_name: "v${{ steps.version.outputs.VERSION }}"
          name: "ğŸ¯ Rasch Model Calculator v${{ steps.version.outputs.VERSION }}"
          body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
          files: |
            release-assets/*
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}

      - name: âœ… Set Release Created Flag
        id: check_release
        run: |
          if [[ "${{ steps.version.outputs.RELEASE_EXISTS }}" == "false" ]]; then
            echo "created=true" >> $GITHUB_OUTPUT
            echo "Release was created"
          else
            echo "created=false" >> $GITHUB_OUTPUT
            echo "Release already existed, skipped creation"
          fi
        shell: bash

      - name: ğŸ“Š Upload Build Artifacts
        uses: actions/upload-artifact@v4.6.2
        with:
          name: rasch-calculator-${{ steps.version.outputs.VERSION }}
          path: |
            release-assets/
            build/reports/
          retention-days: 30

      - name: ğŸ§¹ Cleanup Build Cache
        run: |
          ./gradlew --stop
          rm -rf ~/.gradle/caches/build-cache-*
        shell: bash

  notify-success:
    name: ğŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: [build-and-release]
    if: success() && needs.build-and-release.outputs.release_created == 'true'
    
    steps:
      - name: ğŸ‰ Success Notification
        run: |
          echo "ğŸ‰ Release created successfully!"
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.build-and-release.outputs.version }}"
          echo "ğŸ“¥ Users can now download and auto-update will detect this version"

  notify-failure:
    name: âŒ Build Failure
    runs-on: ubuntu-latest
    needs: [build-and-release]
    if: failure()
    
    steps:
      - name: âŒ Build Failure Notification
        run: |
          echo "âŒ Build failed! Release cancelled."
          echo "ğŸ”— Check workflow: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "âš ï¸ Fix build errors before creating a release"

  notify-skip:
    name: â­ï¸ Release Skipped
    runs-on: ubuntu-latest
    needs: [build-and-release]
    if: success() && needs.build-and-release.outputs.release_created == 'false'
    
    steps:
      - name: â­ï¸ Skip Notification
        run: |
          echo "â­ï¸ Release skipped - version v${{ needs.build-and-release.outputs.version }} already exists"
          echo "ğŸ”— Existing release: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.build-and-release.outputs.version }}"
          echo "ğŸ’¡ Update version in build.gradle.kts to create a new release"
