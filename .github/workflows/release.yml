name: ðŸš€ Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch: 

env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  build-and-release:
    name: ðŸ—ï¸ Build Application
    runs-on: windows-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Setup Java JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: ðŸ˜ Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: wrapper

      - name: ðŸ”§ Make Gradlew Executable
        run: chmod +x ./gradlew
        shell: bash

      - name: ðŸ“¦ Cache Gradle Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ðŸ·ï¸ Extract Version from Tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="development"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
        shell: bash

      - name: ðŸ“ Update Version in Build File
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          sed -i "s/version = \".*\"/version = \"$VERSION\"/" build.gradle.kts
          echo "Updated version to: $VERSION"
        shell: bash

      - name: ðŸ“ Update Application Properties
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          echo "version=$VERSION" > src/main/resources/application.properties
          echo "Updated application.properties with version: $VERSION"
        shell: bash

      - name: ðŸ§ª Run Tests
        run: ./gradlew test
        shell: bash

      - name: ðŸ” Generate Test Report
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: ðŸ“Š Test Results
          path: build/test-results/test/*.xml
          reporter: java-junit

      - name: ðŸ—ï¸ Build Application
        run: ./gradlew clean build
        shell: bash

      - name: ðŸ“¦ Create JPackage Distribution
        run: ./gradlew jpackage
        shell: bash

      - name: ðŸ“ Prepare Release Assets
        run: |
          mkdir -p release-assets
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»
          if [ -f "build/jpackage/RaschModelCalculator-${{ steps.version.outputs.VERSION }}.exe" ]; then
            cp "build/jpackage/RaschModelCalculator-${{ steps.version.outputs.VERSION }}.exe" "release-assets/"
            echo "âœ… Copied installer executable"
          else
            echo "âŒ Installer executable not found"
            ls -la build/jpackage/
          fi
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ JAR Ñ„Ð°Ð¹Ð»
          if [ -f "build/libs/RaschModelCalculator-${{ steps.version.outputs.VERSION }}.jar" ]; then
            cp "build/libs/RaschModelCalculator-${{ steps.version.outputs.VERSION }}.jar" "release-assets/"
            echo "âœ… Copied JAR file"
          else
            echo "âŒ JAR file not found"
            ls -la build/libs/
          fi
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‡ÐµÐºÑÑƒÐ¼Ð¼Ñ‹
          cd release-assets
          sha256sum * > checksums.txt
          cd ..
          
          echo "ðŸ“‹ Release assets prepared:"
          ls -la release-assets/
        shell: bash

      - name: ðŸ“„ Generate Release Notes
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          RELEASE_NOTES="## ðŸŽ‰ Rasch Model Calculator v$VERSION

          ### âœ¨ ÐÐ¾Ð²Ñ‹Ðµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸
          - Ð¡Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ð¸Ð³Ñ€Ð¾Ð²Ð¾Ð¹ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ Ñ Ð³Ñ€Ð°Ð´Ð¸ÐµÐ½Ñ‚Ð°Ð¼Ð¸ Ð¸ ÑÑ„Ñ„ÐµÐºÑ‚Ð°Ð¼Ð¸
          - Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð°Ð²Ñ‚Ð¾Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ñ GitHub Releases
          - Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð½Ñ‹Ðµ ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐ¸ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ð½Ð° dashboard
          - ÐÐ½Ð¸Ð¼Ð°Ñ†Ð¸Ð¸ Ð¸ ÑÐ¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ñ‹
          - ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ð°Ñ Ð½Ð°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ñ Ñ Ð¸ÐºÐ¾Ð½ÐºÐ°Ð¼Ð¸

          ### ðŸ”§ Ð¢ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð¸Ñ
          - ÐŸÐµÑ€ÐµÑ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ð°Ñ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð° UI ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
          - ÐÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹
          - Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð½Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
          - ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ

          ### ðŸ“¦ Ð§Ñ‚Ð¾ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾
          - **RaschModelCalculator-$VERSION.exe** - Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ñ‰Ð¸Ðº Ð´Ð»Ñ Windows
          - **RaschModelCalculator-$VERSION.jar** - JAR Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ Ð²ÑÐµÑ… Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼
          - **checksums.txt** - ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒÐ½Ñ‹Ðµ ÑÑƒÐ¼Ð¼Ñ‹ Ñ„Ð°Ð¹Ð»Ð¾Ð²

          ### ðŸ’» Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ
          - Windows 10 Ð¸Ð»Ð¸ Ð½Ð¾Ð²ÐµÐµ
          - Java 17+ (Ð´Ð»Ñ JAR Ð²ÐµÑ€ÑÐ¸Ð¸)
          - 4 Ð“Ð‘ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¸Ð²Ð½Ð¾Ð¹ Ð¿Ð°Ð¼ÑÑ‚Ð¸
          - 100 ÐœÐ‘ ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð¼ÐµÑÑ‚Ð°

          ### ðŸ”„ ÐÐ²Ñ‚Ð¾Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ
          Ð­Ñ‚Ð° Ð²ÐµÑ€ÑÐ¸Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ. ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð±ÑƒÐ´ÐµÑ‚ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÑ‚ÑŒ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð½Ð¾Ð²Ñ‹Ñ… Ð²ÐµÑ€ÑÐ¸Ð¹ Ð¿Ñ€Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐµ.

          ---
          ðŸ’» Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¾ Ñ â¤ï¸ Miroshka"

          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð² Ñ„Ð°Ð¹Ð» Ð¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ
          echo "$RELEASE_NOTES" > release_notes.md
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "RELEASE_NOTES<<$EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT
        shell: bash

      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: "ðŸŽ¯ Rasch Model Calculator v${{ steps.version.outputs.VERSION }}"
          body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
          files: |
            release-assets/*
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š Upload Build Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: rasch-calculator-${{ steps.version.outputs.VERSION }}
          path: |
            release-assets/
            build/reports/
          retention-days: 30

      - name: ðŸ§¹ Cleanup Build Cache
        run: |
          ./gradlew --stop
          rm -rf ~/.gradle/caches/build-cache-*
        shell: bash

  notify-success:
    name: ðŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: build-and-release
    if: success() && startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: ðŸŽ‰ Success Notification
        run: |
          echo "ðŸŽ‰ Release created successfully!"
          echo "ðŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
          echo "ðŸ“¥ Users can now download and auto-update will detect this version"
